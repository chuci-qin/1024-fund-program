# 1024 Fund Program

> LP åŸºé‡‘ç¨‹åº - åŸºé‡‘ç®¡ç†ã€ä¿é™©åŸºé‡‘ã€è¿”ä½£ç³»ç»Ÿã€é¢„æµ‹å¸‚åœºæ‰‹ç»­è´¹

---

## ðŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æž¶æž„è®¾è®¡](#æž¶æž„è®¾è®¡)
- [è´¦æˆ·ç»“æž„](#è´¦æˆ·ç»“æž„)
- [æŒ‡ä»¤è¯¦è§£](#æŒ‡ä»¤è¯¦è§£)
- [LP æŠ•èµ„ç®¡ç†](#lp-æŠ•èµ„ç®¡ç†)
- [ä¿é™©åŸºé‡‘æœºåˆ¶](#ä¿é™©åŸºé‡‘æœºåˆ¶)
- [è¿”ä½£ç³»ç»Ÿ](#è¿”ä½£ç³»ç»Ÿ)
- [é¢„æµ‹å¸‚åœºæ‰‹ç»­è´¹](#é¢„æµ‹å¸‚åœºæ‰‹ç»­è´¹)
- [PDA åœ°å€æŽ¨å¯¼](#pda-åœ°å€æŽ¨å¯¼)
- [æž„å»ºä¸Žéƒ¨ç½²](#æž„å»ºä¸Žéƒ¨ç½²)
- [æµ‹è¯•](#æµ‹è¯•)
- [é”™è¯¯ä»£ç ](#é”™è¯¯ä»£ç )

---

## æ¦‚è¿°

### ç¨‹åºèŒè´£

1024 Fund Program æ˜¯ 1024 DEX ç”Ÿæ€ç³»ç»Ÿçš„èµ„é‡‘æ± ç®¡ç†æ ¸å¿ƒï¼Œè´Ÿè´£ï¼š

| èŒè´£ | è¯´æ˜Ž |
|------|------|
| **LP åŸºé‡‘ç®¡ç†** | åˆ›å»º/ç®¡ç†æŠ•èµ„åŸºé‡‘ï¼ŒæŽ¥å— LP æŠ•èµ„ |
| **NAV è¿½è¸ª** | å®žæ—¶å‡€å€¼è®¡ç®—ï¼Œä¸šç»©è´¹/ç®¡ç†è´¹æ”¶å– |
| **ä¿é™©åŸºé‡‘** | æ¸…ç®—æ”¶å…¥ã€ç©¿ä»“è¦†ç›–ã€ADL è§¦å‘ |
| **è¿”ä½£ç³»ç»Ÿ** | é‚€è¯·é“¾æŽ¥ã€VIP åŠ æˆã€è‡ªåŠ¨åˆ†ä½£ |
| **é¢„æµ‹å¸‚åœºæ‰‹ç»­è´¹** | é“¸é€ /èµŽå›ž/äº¤æ˜“è´¹æ”¶å–ä¸Žåˆ†é… |
| **Square å¹³å°æ”¯ä»˜** | çŸ¥è¯†ä»˜è´¹ã€è®¢é˜…ã€æ‰“èµç»“ç®— |

### éƒ¨ç½²ä¿¡æ¯

| ç½‘ç»œ | Program ID |
|------|-----------|
| 1024Chain Testnet | `FundPMaFfYBn5z8Dxv95qKmS1rB6HQXC2rvyQ8F4kUL` |
| 1024Chain Mainnet | TBD |

### ç³»ç»Ÿå®šä½

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           1024-fund-program              â”‚
                    â”‚           (èµ„é‡‘æ± ç®¡ç†)                    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚               â”‚               â”‚               â”‚               â”‚
      â–¼               â–¼               â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LP Fund   â”‚  â”‚ Insurance â”‚  â”‚ Referral  â”‚  â”‚ PM Fee    â”‚  â”‚ Square    â”‚
â”‚ Managementâ”‚  â”‚ Fund      â”‚  â”‚ System    â”‚  â”‚ Mgmt      â”‚  â”‚ Payment   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚- Create   â”‚  â”‚- Liquidateâ”‚  â”‚- Invite   â”‚  â”‚- Minting  â”‚  â”‚- Purchase â”‚
â”‚- Deposit  â”‚  â”‚- ADL      â”‚  â”‚- VIP tier â”‚  â”‚- Trading  â”‚  â”‚- Subscribeâ”‚
â”‚- Redeem   â”‚  â”‚- Cover    â”‚  â”‚- Reward   â”‚  â”‚- Creator  â”‚  â”‚- Donate   â”‚
â”‚- Fee      â”‚  â”‚- Snapshot â”‚  â”‚- Discount â”‚  â”‚- Maker    â”‚  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æž¶æž„è®¾è®¡

### Relayer ä¸Žå¤šç­¾æ”¯æŒ

Fund Program æ”¯æŒ Multi-Relayer æœºåˆ¶ï¼Œç”¨äºŽè·¨é“¾æ“ä½œï¼š

```rust
// æœ€å¤šæ”¯æŒ 5 ä¸ªæŽˆæƒ Relayer
pub const MAX_RELAYERS: usize = 5;

// é»˜è®¤é™é¢
pub const DEFAULT_SINGLE_TX_LIMIT_E6: i64 = 100_000_000_000;  // $100,000
pub const DEFAULT_DAILY_LIMIT_E6: i64 = 1_000_000_000_000;    // $1,000,000
```

### Relayer é™é¢æœºåˆ¶

```rust
pub struct RelayerLimits {
    pub single_tx_limit_e6: i64,   // å•ç¬”äº¤æ˜“é™é¢
    pub daily_limit_e6: i64,       // æ¯æ—¥é™é¢
    pub daily_used_e6: i64,        // ä»Šæ—¥å·²ç”¨
    pub last_reset_ts: i64,        // ä¸Šæ¬¡é‡ç½®æ—¶é—´ (UTC 0ç‚¹è‡ªåŠ¨é‡ç½®)
}
```

---

## è´¦æˆ·ç»“æž„

### 1. FundConfig (å…¨å±€é…ç½®)

**PDA Seeds:** `["fund_config"]`

```rust
pub struct FundConfig {
    pub discriminator: u64,
    pub authority: Pubkey,                          // ç®¡ç†å‘˜
    pub vault_program: Pubkey,                      // Vault Program ID
    pub ledger_program: Pubkey,                     // Ledger Program ID
    pub total_funds: u64,                           // æ€»åŸºé‡‘æ•°
    pub active_funds: u64,                          // æ´»è·ƒåŸºé‡‘æ•°
    pub total_tvl_e6: i64,                          // æ€» TVL (e6)
    pub is_paused: bool,
    pub bump: u8,
    
    // Multi-Relayer æ”¯æŒ
    pub authorized_relayers: [Pubkey; 5],           // æŽˆæƒ Relayer åˆ—è¡¨
    pub relayer_active: [bool; 5],                  // Relayer æ¿€æ´»çŠ¶æ€
    pub active_relayer_count: u8,                   // æ´»è·ƒ Relayer æ•°é‡
    pub relayer_limits: RelayerLimits,              // å…¨å±€é™é¢é…ç½®
    pub reserved: [u8; 32],
}
```

### 2. Fund (åŸºé‡‘è´¦æˆ·)

**PDA Seeds:** `["fund", manager_pubkey, fund_index.to_le_bytes()]`

```rust
pub struct Fund {
    pub discriminator: u64,
    pub manager: Pubkey,                // åŸºé‡‘ç»ç†
    pub name: [u8; 32],                 // åŸºé‡‘åç§°
    pub bump: u8,
    pub fund_vault: Pubkey,             // USDC å­˜å‚¨è´¦æˆ·
    pub share_mint: Pubkey,             // ä»½é¢ä»£å¸ Mint
    pub fee_config: FeeConfig,          // è´¹ç”¨é…ç½®
    pub stats: FundStats,               // ç»Ÿè®¡æ•°æ®
    pub is_open: bool,                  // å¼€æ”¾å­˜æ¬¾
    pub is_paused: bool,
    pub created_at: i64,
    pub last_update_ts: i64,
    pub fund_index: u64,                // å”¯ä¸€ç´¢å¼•
    pub reserved: [u8; 64],
}

pub struct FeeConfig {
    pub management_fee_bps: u32,        // ç®¡ç†è´¹ (åŸºç‚¹, 200=2%)
    pub performance_fee_bps: u32,       // ä¸šç»©è´¹ (åŸºç‚¹, 2000=20%)
    pub use_high_water_mark: bool,      // ä½¿ç”¨é«˜æ°´ä½çº¿
    pub fee_collection_interval: i64,   // æ”¶è´¹é—´éš” (ç§’)
}

pub struct FundStats {
    pub total_deposits_e6: i64,
    pub total_withdrawals_e6: i64,
    pub current_nav_e6: i64,            // å½“å‰ NAV (1.0 = 1_000_000)
    pub high_water_mark_e6: i64,        // é«˜æ°´ä½çº¿
    pub total_management_fee_e6: i64,
    pub total_performance_fee_e6: i64,
    pub total_shares: u64,
    pub last_fee_collection_ts: i64,
    pub total_realized_pnl_e6: i64,
    pub lp_count: u32,
}
```

### 3. LPPosition (LP æŒä»“)

**PDA Seeds:** `["lp_position", fund_pubkey, investor_pubkey]`

```rust
pub struct LPPosition {
    pub discriminator: u64,
    pub fund: Pubkey,
    pub investor: Pubkey,
    pub shares: u64,                    // æŒæœ‰ä»½é¢
    pub deposit_nav_e6: i64,            // å­˜å…¥æ—¶ NAV
    pub total_deposited_e6: i64,
    pub total_withdrawn_e6: i64,
    pub deposited_at: i64,
    pub last_update_ts: i64,
    pub bump: u8,
    pub reserved: [u8; 32],
}
```

### 4. InsuranceFundConfig (ä¿é™©åŸºé‡‘é…ç½®)

**PDA Seeds:** `["insurance_fund_config"]`

```rust
pub struct InsuranceFundConfig {
    pub discriminator: u64,
    pub fund: Pubkey,                             // å…³è”çš„ Fund è´¦æˆ·
    pub bump: u8,
    
    // æ”¶å…¥ç»Ÿè®¡
    pub total_liquidation_income_e6: i64,         // æ¸…ç®—æ”¶å…¥
    pub total_adl_profit_e6: i64,                 // ADL ç›ˆä½™
    
    // æ”¯å‡ºç»Ÿè®¡
    pub total_shortfall_payout_e6: i64,           // ç©¿ä»“æ”¯å‡º
    
    // ADL é…ç½®
    pub adl_trigger_threshold_e6: i64,            // ADL è§¦å‘é˜ˆå€¼
    pub adl_trigger_count: u64,                   // ADL è§¦å‘æ¬¡æ•°
    
    // 1å°æ—¶å¿«ç…§ (30%ä¸‹é™æ£€æµ‹)
    pub balance_1h_ago_e6: i64,
    pub last_snapshot_ts: i64,
    
    // LP èµŽå›žæŽ§åˆ¶
    pub withdrawal_delay_secs: i64,               // èµŽå›žå»¶è¿Ÿ
    pub is_adl_in_progress: bool,                 // ADL è¿›è¡Œä¸­
    
    pub authorized_caller: Pubkey,                // æŽˆæƒè°ƒç”¨æ–¹ (Ledger)
    pub last_update_ts: i64,
    pub reserved: [u8; 64],
}
```

### 5. ReferralConfig / ReferralLink / ReferralBinding (è¿”ä½£ç³»ç»Ÿ)

```rust
pub struct ReferralConfig {
    pub discriminator: u64,
    pub authority: Pubkey,
    pub vault_program: Pubkey,
    pub referrer_share_bps: u16,              // é‚€è¯·äººåˆ†æˆ (2000=20%)
    pub referee_discount_bps: u16,            // è¢«é‚€è¯·äººæŠ˜æ‰£ (1000=10%)
    pub referrer_vip_bonus_bps: [u16; 6],     // VIP ç­‰çº§åŠ æˆ
    pub referee_vip_bonus_bps: [u16; 6],      // VIP ç­‰çº§æŠ˜æ‰£åŠ æˆ
    pub min_settlement_amount_e6: i64,        // æœ€ä½Žç»“ç®—é‡‘é¢
    pub reward_validity_secs: i64,            // è¿”ä½£æœ‰æ•ˆæœŸ (0=æ°¸ä¹…)
    
    // ç»Ÿè®¡
    pub total_rewards_paid_e6: i64,
    pub total_discounts_given_e6: i64,
    pub total_referral_links: u64,
    pub total_referred_users: u64,
    pub total_referred_volume_e6: i64,
    
    pub is_paused: bool,
    pub bump: u8,
    pub last_update_ts: i64,
    pub reserved: [u8; 64],
}

pub struct ReferralLink {
    pub discriminator: u64,
    pub referrer: Pubkey,
    pub code: [u8; 12],                       // é‚€è¯·ç 
    pub created_at: i64,
    pub is_active: bool,
    pub custom_referrer_share_bps: u16,       // è‡ªå®šä¹‰åˆ†æˆ
    pub custom_referee_discount_bps: u16,     // è‡ªå®šä¹‰æŠ˜æ‰£
    pub referred_count: u32,
    pub total_volume_e6: i64,
    pub total_rewards_earned_e6: i64,
    pub total_discounts_given_e6: i64,
    pub bump: u8,
    pub reserved: [u8; 32],
}

pub struct ReferralBinding {
    pub discriminator: u64,
    pub referee: Pubkey,                      // è¢«é‚€è¯·äºº
    pub referrer: Pubkey,                     // é‚€è¯·äºº
    pub referral_link: Pubkey,
    pub bound_at: i64,
    pub referee_volume_e6: i64,
    pub referrer_rewards_e6: i64,
    pub referee_discounts_e6: i64,
    pub trade_count: u64,
    pub last_trade_ts: i64,
    pub bump: u8,
    pub reserved: [u8; 32],
}
```

### 6. PredictionMarketFeeConfig (é¢„æµ‹å¸‚åœºæ‰‹ç»­è´¹é…ç½®)

**PDA Seeds:** `["prediction_market_fee_config"]`

```rust
pub struct PredictionMarketFeeConfig {
    pub discriminator: u64,
    pub prediction_market_fee_vault: Pubkey,      // USDC æ‰‹ç»­è´¹æ± 
    pub bump: u8,
    
    // è´¹çŽ‡é…ç½® (basis points)
    pub prediction_market_minting_fee_bps: u16,        // é“¸é€ è´¹ (10=0.1%)
    pub prediction_market_redemption_fee_bps: u16,     // èµŽå›žè´¹
    pub prediction_market_trading_fee_taker_bps: u16,  // Taker äº¤æ˜“è´¹
    pub prediction_market_trading_fee_maker_bps: u16,  // Maker äº¤æ˜“è´¹ (é€šå¸¸ 0)
    pub prediction_market_settlement_fee_bps: u16,     // ç»“ç®—è´¹
    
    // åˆ†é…æ¯”ä¾‹ (æ€»è®¡ 10000)
    pub prediction_market_protocol_share_bps: u16,     // åè®®æ”¶å…¥ (7000=70%)
    pub prediction_market_maker_reward_share_bps: u16, // åšå¸‚å•†å¥–åŠ± (2000=20%)
    pub prediction_market_creator_share_bps: u16,      // åˆ›å»ºè€…åˆ†æˆ (1000=10%)
    
    // ç´¯è®¡ç»Ÿè®¡
    pub prediction_market_total_minting_fee_e6: i64,
    pub prediction_market_total_redemption_fee_e6: i64,
    pub prediction_market_total_trading_fee_e6: i64,
    pub prediction_market_total_maker_rewards_e6: i64,
    pub prediction_market_total_creator_rewards_e6: i64,
    pub prediction_market_total_protocol_income_e6: i64,
    
    pub prediction_market_authorized_caller: Pubkey,   // PM Program
    pub authority: Pubkey,
    pub is_paused: bool,
    pub last_update_ts: i64,
    pub reserved: [u8; 64],
}
```

---

## æŒ‡ä»¤è¯¦è§£

### åˆå§‹åŒ–æŒ‡ä»¤

| æŒ‡ä»¤ | è¯´æ˜Ž |
|------|------|
| `Initialize` | åˆå§‹åŒ– FundConfig |
| `InitializeInsuranceFund` | åˆå§‹åŒ–ä¿é™©åŸºé‡‘ |
| `InitializeReferral` | åˆå§‹åŒ–è¿”ä½£ç³»ç»Ÿ |
| `InitializePredictionMarketFeeConfig` | åˆå§‹åŒ– PM æ‰‹ç»­è´¹é…ç½® |

### LP åŸºé‡‘æŒ‡ä»¤

| æŒ‡ä»¤ | è¯´æ˜Ž | è°ƒç”¨è€… |
|------|------|--------|
| `CreateFund` | åˆ›å»ºæ–°åŸºé‡‘ | åŸºé‡‘ç»ç† |
| `DepositToFund` | LP å­˜å…¥ | LP |
| `RedeemFromFund` | LP èµŽå›ž | LP |
| `CollectFees` | æ”¶å–è´¹ç”¨ | åŸºé‡‘ç»ç† |
| `TradeFund` | åŸºé‡‘äº¤æ˜“ | åŸºé‡‘ç»ç† |
| `UpdateNAV` | æ›´æ–°å‡€å€¼ | ä»»ä½•äºº |
| `SetFundOpen` | å¼€å…³å­˜æ¬¾ | åŸºé‡‘ç»ç† |
| `CloseFund` | å…³é—­åŸºé‡‘ | åŸºé‡‘ç»ç† |

### ä¿é™©åŸºé‡‘æŒ‡ä»¤ (CPI)

| æŒ‡ä»¤ | è¯´æ˜Ž | è°ƒç”¨è€… |
|------|------|--------|
| `AddLiquidationIncome` | æ·»åŠ æ¸…ç®—æ”¶å…¥ | Ledger |
| `AddADLProfit` | æ·»åŠ  ADL ç›ˆä½™ | Ledger |
| `CoverShortfall` | è¦†ç›–ç©¿ä»“ | Ledger |
| `AddTradingFee` | æ·»åŠ äº¤æ˜“æ‰‹ç»­è´¹ | Ledger |
| `SetADLInProgress` | è®¾ç½® ADL çŠ¶æ€ | Ledger |
| `UpdateHourlySnapshot` | æ›´æ–°å°æ—¶å¿«ç…§ | Relayer |
| `CheckADLTrigger` | æ£€æŸ¥ ADL æ¡ä»¶ | ä»»ä½•äºº |
| `RedeemFromInsuranceFund` | ä¿é™©åŸºé‡‘èµŽå›ž | LP |

### è¿”ä½£ç³»ç»ŸæŒ‡ä»¤

| æŒ‡ä»¤ | è¯´æ˜Ž | è°ƒç”¨è€… |
|------|------|--------|
| `CreateReferralLink` | åˆ›å»ºé‚€è¯·é“¾æŽ¥ | ç”¨æˆ· |
| `BindReferral` | ç»‘å®šé‚€è¯·å…³ç³» | æ–°ç”¨æˆ· |
| `RecordReferralTrade` | è®°å½•è¿”ä½£äº¤æ˜“ | Ledger (CPI) |
| `UpdateReferralConfig` | æ›´æ–°è¿”ä½£é…ç½® | Admin |
| `DeactivateReferralLink` | åœç”¨é‚€è¯·é“¾æŽ¥ | é‚€è¯·äºº |
| `SetCustomReferralRates` | è®¾ç½®è‡ªå®šä¹‰æ¯”ä¾‹ | Admin |

### é¢„æµ‹å¸‚åœºæ‰‹ç»­è´¹æŒ‡ä»¤

| æŒ‡ä»¤ | è¯´æ˜Ž | è°ƒç”¨è€… |
|------|------|--------|
| `CollectPredictionMarketMintingFee` | æ”¶å–é“¸é€ è´¹ | PM Program (CPI) |
| `CollectPredictionMarketRedemptionFee` | æ”¶å–èµŽå›žè´¹ | PM Program (CPI) |
| `CollectPredictionMarketTradingFee` | æ”¶å–äº¤æ˜“è´¹ | PM Program (CPI) |
| `DistributePredictionMarketMakerReward` | å‘æ”¾åšå¸‚å•†å¥–åŠ± | Admin / PM |
| `DistributePredictionMarketCreatorReward` | å‘æ”¾åˆ›å»ºè€…åˆ†æˆ | PM Program (CPI) |
| `UpdatePredictionMarketFeeConfig` | æ›´æ–°è´¹çŽ‡é…ç½® | Admin |
| `SetPredictionMarketFeePaused` | æš‚åœ/æ¢å¤ | Admin |

### Relayer æŒ‡ä»¤

| æŒ‡ä»¤ | è¯´æ˜Ž |
|------|------|
| `RelayerDepositToFund` | Relayer ä»£ç†å­˜æ¬¾ |
| `RelayerRedeemFromFund` | Relayer ä»£ç†èµŽå›ž |
| `RelayerRedeemFromInsuranceFund` | Relayer ä»£ç†ä¿é™©åŸºé‡‘èµŽå›ž |
| `RelayerSquarePayment` | Relayer ä»£ç† Square æ”¯ä»˜ |
| `RelayerBindReferral` | Relayer ä»£ç†ç»‘å®šé‚€è¯· |
| `AddRelayer` | æ·»åŠ  Relayer (Admin) |
| `RemoveRelayer` | ç§»é™¤ Relayer (Admin) |
| `UpdateRelayerLimits` | æ›´æ–° Relayer é™é¢ (Admin) |

---

## LP æŠ•èµ„ç®¡ç†

### NAV è®¡ç®—

```rust
// NAV = Total Value / Total Shares
// Total Value = Deposits - Withdrawals + Realized PnL - Fees

impl FundStats {
    pub fn total_value_e6(&self) -> i64 {
        self.total_deposits_e6
            .saturating_sub(self.total_withdrawals_e6)
            .saturating_add(self.total_realized_pnl_e6)
            .saturating_sub(self.total_management_fee_e6)
            .saturating_sub(self.total_performance_fee_e6)
    }
}
```

### è´¹ç”¨è®¡ç®—

**ç®¡ç†è´¹ (æ—¶é—´çº¿æ€§):**
```
Management Fee = AUM Ã— Fee_Rate Ã— Time_Elapsed / Year
```

**ä¸šç»©è´¹ (High Water Mark):**
```
// ä»…å½“ NAV > HWM æ—¶æ”¶å–
Performance Fee = (NAV - HWM) Ã— Total_Value Ã— Fee_Rate / NAV
```

---

## ä¿é™©åŸºé‡‘æœºåˆ¶

### ADL ä¸‰é‡è§¦å‘æ¡ä»¶

```rust
pub fn should_trigger_adl(&self, balance: i64, shortfall: i64) -> ADLTriggerReason {
    // æ¡ä»¶ 1: ç©¿ä»“è§¦å‘ - ä¿é™©åŸºé‡‘æ— æ³•è¦†ç›–
    if shortfall > 0 && balance < shortfall {
        return ADLTriggerReason::Bankruptcy;
    }
    
    // æ¡ä»¶ 2: ä½™é¢ä¸è¶³ - ä½ŽäºŽé˜ˆå€¼
    if balance < self.adl_trigger_threshold_e6 {
        return ADLTriggerReason::InsufficientBalance;
    }
    
    // æ¡ä»¶ 3: 1å°æ—¶å¿«é€Ÿä¸‹é™ - ä¸‹é™è¶…è¿‡ 30%
    if self.balance_1h_ago_e6 > 0 {
        let threshold = self.balance_1h_ago_e6 * 70 / 100;
        if balance < threshold {
            return ADLTriggerReason::RapidDecline;
        }
    }
    
    ADLTriggerReason::None
}
```

### ä¿é™©åŸºé‡‘æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¿é™©åŸºé‡‘èµ„é‡‘æµ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     æ”¶å…¥æ¥æº                                â”‚
â”‚   â”‚               â”‚ â—„â”€â”€ æ¸…ç®—ç½šé‡‘ (Liquidation)                  â”‚
â”‚   â”‚   Insurance   â”‚ â—„â”€â”€ ADL ç›ˆä½™                                â”‚
â”‚   â”‚     Fund      â”‚ â—„â”€â”€ äº¤æ˜“æ‰‹ç»­è´¹ (10% åˆ†æˆ)                    â”‚
â”‚   â”‚               â”‚                                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚           â”‚                                                     â”‚
â”‚           â”‚  æ”¯å‡º                                                â”‚
â”‚           â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚   â”‚ Cover Shortfallâ”‚ â”€â”€â–º ç©¿ä»“è¦†ç›–                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚           â”‚                                                     â”‚
â”‚           â”‚ ä¸è¶³æ—¶                                               â”‚
â”‚           â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚   â”‚  Trigger ADL  â”‚ â”€â”€â–º è‡ªåŠ¨å‡ä»“ç›ˆåˆ©æ–¹                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¿”ä½£ç³»ç»Ÿ

### VIP ç­‰çº§åŠ æˆ

| VIP ç­‰çº§ | é‚€è¯·äººåŠ æˆ | è¢«é‚€è¯·äººæŠ˜æ‰£åŠ æˆ |
|----------|-----------|------------------|
| VIP 0 | 0% | 0% |
| VIP 1 | 2% | 2% |
| VIP 2 | 5% | 5% |
| VIP 3 | 10% | 10% |
| VIP 4 | 15% | 15% |
| VIP 5 | 20% | 20% |

### è¿”ä½£è®¡ç®—ç¤ºä¾‹

```rust
// åŸºç¡€é…ç½®: é‚€è¯·äºº 20%, è¢«é‚€è¯·äººæŠ˜æ‰£ 10%
// äº¤æ˜“æ‰‹ç»­è´¹: $100

// VIP 0:
// è¢«é‚€è¯·äººæŠ˜æ‰£: $100 Ã— 10% = $10
// å®žé™…æ”¶è´¹: $100 - $10 = $90
// é‚€è¯·äººè¿”ä½£: $90 Ã— 20% = $18
// å¹³å°æ”¶å…¥: $90 - $18 = $72

// VIP 3 (å–ä¸¤äººæœ€é«˜ç­‰çº§):
// è¢«é‚€è¯·äººæŠ˜æ‰£: $100 Ã— 20% = $20
// å®žé™…æ”¶è´¹: $100 - $20 = $80
// é‚€è¯·äººè¿”ä½£: $80 Ã— 30% = $24
// å¹³å°æ”¶å…¥: $80 - $24 = $56
```

---

## é¢„æµ‹å¸‚åœºæ‰‹ç»­è´¹

### è´¹çŽ‡é…ç½®

| è´¹ç”¨ç±»åž‹ | é»˜è®¤è´¹çŽ‡ | è¯´æ˜Ž |
|----------|---------|------|
| é“¸é€ è´¹ | 0.1% | MintCompleteSet æ—¶æ”¶å– |
| èµŽå›žè´¹ | 0.1% | RedeemCompleteSet æ—¶æ”¶å– |
| Taker äº¤æ˜“è´¹ | 0.1% | åƒå•äº¤æ˜“ |
| Maker äº¤æ˜“è´¹ | 0% | æŒ‚å•äº¤æ˜“ |

### åˆ†é…æ¯”ä¾‹

| æŽ¥æ”¶æ–¹ | é»˜è®¤æ¯”ä¾‹ | è¯´æ˜Ž |
|--------|---------|------|
| åè®®æ”¶å…¥ | 70% | è¿›å…¥åè®®é‡‘åº“ |
| åšå¸‚å•†å¥–åŠ± | 20% | æ¿€åŠ±æä¾›æµåŠ¨æ€§ |
| åˆ›å»ºè€…åˆ†æˆ | 10% | å¸‚åœºåˆ›å»ºè€…æ”¶ç›Š |

---

## PDA åœ°å€æŽ¨å¯¼

### TypeScript ç¤ºä¾‹

```typescript
const FUND_PROGRAM_ID = new PublicKey('FundPMaFfYBn5z8Dxv95qKmS1rB6HQXC2rvyQ8F4kUL');

// FundConfig PDA
const [fundConfigPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("fund_config")],
    FUND_PROGRAM_ID
);

// Fund PDA
const fundIndex = 0n;
const [fundPDA] = await PublicKey.findProgramAddress(
    [
        Buffer.from("fund"),
        manager.toBuffer(),
        Buffer.from(fundIndex.toString(16).padStart(16, '0'), 'hex'),
    ],
    FUND_PROGRAM_ID
);

// Fund Vault PDA
const [fundVaultPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("fund_vault"), fundPDA.toBuffer()],
    FUND_PROGRAM_ID
);

// Share Mint PDA
const [shareMintPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("share_mint"), fundPDA.toBuffer()],
    FUND_PROGRAM_ID
);

// LP Position PDA
const [lpPositionPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("lp_position"), fundPDA.toBuffer(), investor.toBuffer()],
    FUND_PROGRAM_ID
);

// Insurance Fund Config PDA
const [insuranceConfigPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("insurance_fund_config")],
    FUND_PROGRAM_ID
);

// Referral Config PDA
const [referralConfigPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("referral_config")],
    FUND_PROGRAM_ID
);

// Referral Link PDA
const [referralLinkPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("referral_link"), referrer.toBuffer()],
    FUND_PROGRAM_ID
);

// Referral Binding PDA
const [referralBindingPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("referral_binding"), referee.toBuffer()],
    FUND_PROGRAM_ID
);

// Prediction Market Fee Config PDA
const [pmFeeConfigPDA] = await PublicKey.findProgramAddress(
    [Buffer.from("prediction_market_fee_config")],
    FUND_PROGRAM_ID
);
```

---

## æž„å»ºä¸Žéƒ¨ç½²

### æž„å»º

```bash
cd 1024-fund-program

# ç¼–è¯‘æ£€æŸ¥
cargo check

# è¿è¡Œæµ‹è¯•
cargo test --lib

# æž„å»º BPF ç¨‹åº
cargo build-sbf
```

### éƒ¨ç½²

```bash
# éƒ¨ç½²åˆ° 1024Chain Testnet
solana program deploy target/deploy/fund_program.so \
    --url https://testnet-rpc.1024chain.com/rpc/ \
    --program-id FundPMaFfYBn5z8Dxv95qKmS1rB6HQXC2rvyQ8F4kUL \
    --use-rpc
```

---

## æµ‹è¯•

### å•å…ƒæµ‹è¯•è¦†ç›–

| æµ‹è¯•é¡¹ | æ–‡ä»¶ | çŠ¶æ€ |
|--------|------|------|
| FundConfig SIZE è®¡ç®— | `state.rs` | âœ… |
| Fund åˆ›å»ºå’Œå­˜å–æ¬¾ | `state.rs` | âœ… |
| LPPosition æ”¶ç›Šè®¡ç®— | `state.rs` | âœ… |
| FundStats NAV æ›´æ–° | `state.rs` | âœ… |
| InsuranceFundConfig ADL è§¦å‘ | `state.rs` | âœ… |
| InsuranceFundConfig è¦†ç›–ç©¿ä»“ | `state.rs` | âœ… |
| SquarePaymentRecord åˆ›å»º | `state.rs` | âœ… |
| ReferralConfig VIP åŠ æˆ | `state.rs` | âœ… |
| ReferralConfig è¿”ä½£è®¡ç®— | `state.rs` | âœ… |
| ReferralLink ç»Ÿè®¡ | `state.rs` | âœ… |
| ReferralBinding äº¤æ˜“è®°å½• | `state.rs` | âœ… |
| æŒ‡ä»¤åºåˆ—åŒ– | `instruction.rs` | âœ… |

### è¿è¡Œæµ‹è¯•

```bash
cargo test --lib
# 20+ tests passed
```

---

## é”™è¯¯ä»£ç 

| é”™è¯¯ | Code | è¯´æ˜Ž |
|------|------|------|
| `InsufficientShares` | 0 | ä»½é¢ä¸è¶³ |
| `InsufficientBalance` | 1 | ä½™é¢ä¸è¶³ |
| `FundNotOpen` | 2 | åŸºé‡‘æœªå¼€æ”¾å­˜æ¬¾ |
| `FundPaused` | 3 | åŸºé‡‘å·²æš‚åœ |
| `InvalidManager` | 4 | éžåŸºé‡‘ç»ç† |
| `InvalidFeeConfig` | 5 | æ— æ•ˆçš„è´¹ç”¨é…ç½® |
| `NAVCalculationError` | 6 | NAV è®¡ç®—é”™è¯¯ |
| `Overflow` | 7 | æ•°å€¼æº¢å‡º |
| `ADLInProgress` | 8 | ADL è¿›è¡Œä¸­ï¼Œç¦æ­¢èµŽå›ž |
| `WithdrawalDelayNotMet` | 9 | èµŽå›žå»¶è¿Ÿæœªæ»¡è¶³ |
| `UnauthorizedCaller` | 10 | æœªæŽˆæƒçš„ CPI è°ƒç”¨ |
| `ReferralLinkNotActive` | 11 | é‚€è¯·é“¾æŽ¥æœªæ¿€æ´» |
| `AlreadyBound` | 12 | å·²ç»‘å®šé‚€è¯·å…³ç³» |
| `PMFeePaused` | 13 | é¢„æµ‹å¸‚åœºæ‰‹ç»­è´¹å·²æš‚åœ |
| `RelayerLimitExceeded` | 14 | Relayer é™é¢è¶…å‡º |
| `MaxRelayersReached` | 15 | Relayer æ•°é‡å·²æ»¡ |
| `RelayerNotFound` | 16 | Relayer æœªæ‰¾åˆ° |

---

## æ–‡ä»¶ç»“æž„

```
1024-fund-program/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ rust-toolchain.toml
â””â”€â”€ src/
    â”œâ”€â”€ lib.rs          # ç¨‹åºå…¥å£ç‚¹
    â”œâ”€â”€ state.rs        # è´¦æˆ·ç»“æž„å®šä¹‰
    â”œâ”€â”€ instruction.rs  # æŒ‡ä»¤æžšä¸¾å®šä¹‰
    â”œâ”€â”€ processor.rs    # æŒ‡ä»¤å¤„ç†é€»è¾‘
    â”œâ”€â”€ error.rs        # é”™è¯¯ç±»åž‹
    â”œâ”€â”€ utils.rs        # å·¥å…·å‡½æ•° (NAV/Fee è®¡ç®—)
    â””â”€â”€ cpi.rs          # CPI Helper å‡½æ•°
```

---

## License

MIT

---

*Last Updated: 2025-12-09*
